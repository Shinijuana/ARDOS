<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  </head>
  <body style="margin: 0px; overflow: hidden;">
    <a-scene embedded>
      <a-box id="box" position="0 0 0" material="opacity: 0.5;"></a-box>
    </a-scene>
    <video id="video" width="640" height="480" autoplay style="display: none;"></video>
    <script>
      // Load the template image
      const templateImage = new Image();
      templateImage.src = 'images/marker.jpg'; // Replace with your image path
      let templateLoaded = false;
      let templateMat = null;

      templateImage.onload = () => {
        templateLoaded = true;
        const canvas = document.createElement('canvas');
        canvas.width = templateImage.width;
        canvas.height = templateImage.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(templateImage, 0, 0);
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        templateMat = cv.matFromImageData(imgData);
      };

      // Wait for OpenCV to load
      function onOpenCvReady() {
        console.log('OpenCV.js is ready');
        
        const video = document.getElementById('video');
        const box = document.getElementById('box');
        
        // Access the webcam
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(stream => {
            video.srcObject = stream;
            video.play();
          });

        video.addEventListener('play', () => {
          const src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
          const gray = new cv.Mat();
          const result = new cv.Mat();
          const templateGray = new cv.Mat();
          
          function processVideo() {
            if (templateLoaded) {
              cv.imshow('canvas', src);
              const canvas = document.getElementById('canvas');
              const ctx = canvas.getContext('2d');
              const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              src.data.set(imgData.data);
              cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
              cv.cvtColor(templateMat, templateGray, cv.COLOR_RGBA2GRAY);
              
              // Perform template matching
              cv.matchTemplate(gray, templateGray, result, cv.TM_CCOEFF_NORMED);
              const minMax = cv.minMaxLoc(result);
              const { maxLoc } = minMax;
              
              // Update A-Frame box position based on template location
              box.setAttribute('position', `${maxLoc.x / 100 - 3.2} ${maxLoc.y / 100 - 2.4} -5`);
              
              // Cleanup
              result.delete();
              gray.delete();
              templateGray.delete();
            }
            requestAnimationFrame(processVideo);
          }
          
          requestAnimationFrame(processVideo);
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        if (cv.getBuildInformation) {
          onOpenCvReady();
        } else {
          document.addEventListener('opencvready', onOpenCvReady);
        }
      });
    </script>
  </body>
</html>
